/* &copy; 2014 Lindsay Roberts http://www.designbyfish.com/ */
!function(){var a=angular.module("bloop",["ngRoute","firebase","angularUtils.directives.dirPagination","xeditable"]);a.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/dashboard",{templateUrl:"views/tickets.html",controller:"DashboardCtrl"}).when("/dashboard/ticket/:fbid",{templateUrl:"views/ticket.html",controller:"TicketCtrl"}).when("/myaccount",{templateUrl:"views/account.html",controller:"AccountCtrl"}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl"}).when("/messages",{templateUrl:"views/messages.html",controller:"MessagesCtrl"}).when("/dashboard/message",{templateUrl:"views/message.html",controller:"MessageCtrl"})}]),a.run(["$rootScope","$firebase","$firebaseSimpleLogin",function(a,b,c){a.url="https://dbf-bloop.firebaseio.com/",a.dataRef=new Firebase(a.url),a.loginObj=c(a.dataRef)}]),a.filter("reverse",function(){return function(a){return a.slice().reverse()}}),a.directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),a.directive("scrollGlue",["$parse",function(a){function b(a){var b=a;return{getValue:function(){return b},setValue:function(a){b=a}}}function c(a,b){return{getValue:function(){return a(b)},setValue:function(){}}}function d(a,b,c){return{getValue:function(){return a(c)},setValue:function(d){d!==a(c)&&c.$apply(function(){b(c,d)})}}}function e(e,f){if(""!==e){var g=a(e);return void 0!==g.assign?d(g,g.assign,f):c(g,f)}return b(!0)}return{priority:1,restrict:"A",link:function(a,b,c){function d(){i.scrollTop=i.scrollHeight}function f(){j.getValue()&&d()}function g(){return i.scrollTop+i.clientHeight+1>=i.scrollHeight}function h(){j.setValue(g())}var i=b[0],j=e(c.scrollGlue,a);a.$watch(f),b.bind("scroll",h)}}}]),a.controller("HomeCtrl",["$rootScope","$scope","$firebase",function(a,b,c){function d(){var a=e(),b={fbid:"",id:a,status:"OPEN",name:"N/A",email:"N/A",date:f(),opID:"Unassigned",opName:"Unassigned",archive:[],notes:[]};return b}function e(){for(var a="0123456789ABCDEFGHJKLMNPQRSTUVWXYZ",b="",c=12;c>0;--c)b+=a[Math.round(Math.random()*(a.length-1))];return b}function f(){var a=new Date,b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();10>b&&(b="0"+b),10>c&&(b="0"+c);var e=c+"/"+b+"/"+d;return e}console.log("HomeController!");var g="https://dbf-bloop.firebaseio.com/tickets/",h=new Firebase(g);b.createTicket=function(){b.tickets=c(h).$asArray(),b.tickets.$add(b.ticketObject).then(function(a){var c=a.name();b.ticketObject.fbid=c,b.currentFBID=c,b.syncTickets(),console.log("==========================="),console.log("CREATED TICKET: "+b.currentFBID),console.log("URL: "+g+b.currentFBID),console.log("===========================")})};var i=null;b.syncTickets=function(){var a=new Firebase(g+b.currentFBID);i=c(a),b.currentChat=i.$asObject(),i.$set(b.ticketObject);var d=new Firebase(g+b.currentFBID+"/archive");b.currentArchive=c(d).$asArray(),console.log("==========================="),console.log("SAVED TICKET: "+b.currentFBID),console.log("URL: "+a),console.log("ARCHIVE URL: "+d),console.log("===========================")},b.post=function(a){b.currentArchive.$add({name:a,text:b.chatText,"class":"guestMessage"}),b.chatText=""},a.close=function(){console.log("CHATBOX WAS CLOSED!"),0===b.currentArchive.length?(console.log("DESTROYING CHAT..."),i.$remove()):(b.currentChat.status="CLOSED",b.currentChat.$save()),b.ticketObject={},b.ticketExists=!1},b.toggle=function(){b.toggleState===!1?b.toggleState=!0:b.toggleState===!0&&(b.toggleState=!1)},b.checkTicket=function(){console.log("TICKET EXISTS: "+b.ticketExists),b.ticketExists===!1&&b.toggleState===!1&&(b.ticketObject=d(),b.createTicket(),b.ticketExists=!0)}}]),a.controller("DashboardCtrl",["$rootScope","$scope","$firebase","$firebaseSimpleLogin","$location",function(a,b,c,d,e){console.log("DashboardController!");var f=new Firebase("https://dbf-bloop.firebaseio.com/tickets");b.tickets=c(f).$asArray(),a.loginObj.$getCurrentUser().then(function(a){null===a&&e.path("/login")}),b.disabledTicket=function(){b.disabledLink=!0,b.disabledIcon=!0}}]),a.controller("LoginCtrl",["$rootScope","$scope","$firebase","$firebaseSimpleLogin","$location",function(a,b,c,d,e){console.log("LoginController!"),b.login=function(){a.loginObj.$login("password",{email:b.email,password:b.password}).then(function(a){console.log("Logged in as: ",a.uid),e.path("/dashboard")},function(a){console.log("Login failed: ",a)})}}]),a.controller("AccountCtrl",["$rootScope","$scope","$firebase","$location",function(a,b,c,d){function e(d){var e=new Firebase(a.url+"users/"+d);b.currentUser=c(e).$asObject()}console.log("AccountController!");var f=null;a.loginObj.$getCurrentUser().then(function(a){null===a?d.path("/login"):(e(a.id),f=a)}),b.resetPassword=function(){a.loginObj.$changePassword(f.email,b.currentPass,b.newPass).then(function(){console.log("Success!")},function(a){console.log("ERROR:",a)})}}]),a.controller("AdminCtrl",["$rootScope","$scope","$firebase",function(a,b,c){console.log("AdminController!");var d="https://dbf-bloop.firebaseio.com/users/";b.createUser=function(){console.log(b.input.usertype);var e=b.input.usertype,f=b.input.firstname,g=b.input.lastname;a.loginObj.$createUser(b.input.email,"bloop").then(function(a){var h=new Firebase(d+a.id),i=c(h);b.user=i.$asObject(),i.$set({id:a.id,type:e,firstname:f,lastname:g,email:a.email,level:1,experience:0,ratings:[],tickets:[]})},function(a){console.log("Create user failed: ",a)}),b.input.firstname="",b.input.lastname="",b.input.username="",b.input.email="",b.input.usertype=""}}]),a.controller("MessagesCtrl",[function(){console.log("MessagesController!")}]),a.controller("MessageCtrl",[function(){console.log("MessageController!")}]),a.controller("TicketCtrl",["$rootScope","$scope","$firebase","$routeParams",function(a,b,c,d){var e=new Firebase("https://dbf-bloop.firebaseio.com/tickets/"+d.fbid),f=c(e);b.ticket=f.$asObject();var g=new Firebase("https://dbf-bloop.firebaseio.com/tickets/"+d.fbid+"/archive");currentArchive=c(g),b.currentArchive=currentArchive.$asArray(),a.loginObj.$getCurrentUser().then(function(a){if(null===a)$location.path("/login");else{var b=new Firebase("https://dbf-bloop.firebaseio.com/users/"+a.id);e.on("value",function(a){var c=a.val();"OPEN"===c.status&&b.on("value",function(a){console.log(a.val());var b=a.val();f.$update({opName:b.firstname,opID:b.id,status:"TAKEN"}),console.log("UPDATED TICKET!")})})}}),"OPEN"==b.ticket.status?b.value=1:"TAKEN"==b.ticket.status?b.value=2:"CLOSED"==b.ticket.status&&(b.value=3),b.statuses=[{value:"OPEN",text:"OPEN"},{value:"TAKEN",text:"TAKEN"},{value:"CLOSED",text:"CLOSED"}],b.showStatus=function(){var a=(b.statuses,{value:b.ticket.status});return console.log("TICKET STATUS: "+b.ticket.status),b.user.status&&a.length?a[0].text:"Not set"},b.saveData=function(a,c){"ticket.name"===c?b.ticket.name=a:"ticket.email"===c?b.ticket.email=a:"ticket.notes"===c&&(b.ticket.notes=a),b.ticket.$save()},b.post=function(a){console.log("The operator's name is: "+a);var c=document.querySelector("#messageArchive"),d=c.scrollHeight-c.clientHeight<=c.scrollTop+1;d||(c.scrollTop=c.scrollHeight-c.clientHeight),b.currentArchive.$add({name:a,text:b.repChatText,"class":"repMessage"}),console.log(b.repChatText),b.repChatText=""}}])}();