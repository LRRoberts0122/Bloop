/* &copy; 2014 Lindsay Roberts http://www.designbyfish.com/ */
!function(){var a=angular.module("bloop",["ngRoute","firebase","angularUtils.directives.dirPagination","xeditable"]);a.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/dashboard",{templateUrl:"views/tickets.html",controller:"DashboardCtrl"}).when("/dashboard/ticket/:fbid",{templateUrl:"views/ticket.html",controller:"TicketCtrl"}).when("/myaccount",{templateUrl:"views/account.html",controller:"AccountCtrl"}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl"})}]),a.run(["$rootScope","$firebase","$firebaseSimpleLogin",function(a,b,c){a.url="https://dbf-bloop.firebaseio.com/",a.dataRef=new Firebase(a.url),a.loginObj=c(a.dataRef),a.giveXP=function(c,d){ref=new Firebase(a.url+"users/"+c),obj=b(ref).$asObject(),obj.$loaded().then(function(){obj.experience+=d,obj.experience>=1e3&&(obj.experience=obj.experience-1e3,obj.level++),obj.$save(),console.log("GAVE XP!")})}}]),a.filter("reverse",function(){return function(a){return a.slice().reverse()}}),a.directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),a.controller("HomeCtrl",["$rootScope","$scope","$firebase",function(a,b,c){function d(){var a=e(),b={fbid:"",id:a,status:"OPEN",name:"N/A",email:"N/A",date:f(),opID:"Unassigned",opName:"Unassigned",archive:[],notes:[]};return b}function e(){for(var a="0123456789ABCDEFGHJKLMNPQRSTUVWXYZ",b="",c=12;c>0;--c)b+=a[Math.round(Math.random()*(a.length-1))];return b}function f(){var a=new Date,b=a.getDate(),c=a.getMonth()+1,d=a.getFullYear();10>b&&(b="0"+b),10>c&&(b="0"+c);var e=c+"/"+b+"/"+d;return e}console.log("HomeController!");var g="https://dbf-bloop.firebaseio.com/tickets/",h=new Firebase(g),i=null;b.createTicket=function(){b.tickets=c(h).$asArray(),b.tickets.$add(b.ticketObject).then(function(a){var c=a.name();b.ticketObject.fbid=c,b.currentFBID=c,b.syncTickets(),console.log("==========================="),console.log("CREATED TICKET: "+b.currentFBID),console.log("URL: "+g+b.currentFBID),console.log("===========================")})},b.syncTickets=function(){var a=new Firebase(g+b.currentFBID);i=c(a),b.currentChat=i.$asObject(),i.$set(b.ticketObject);var d=new Firebase(g+b.currentFBID+"/archive");b.currentArchive=c(d).$asArray(),console.log("==========================="),console.log("SAVED TICKET: "+b.currentFBID),console.log("URL: "+a),console.log("ARCHIVE URL: "+d),console.log("===========================")},b.post=function(a){""!=b.chatText&&(b.currentArchive.$add({name:a,text:b.chatText,"class":"guestMessage"}).then(function(){if(b.toggleState===!0){var a=document.querySelector(".chatText"),c=a.scrollHeight-a.clientHeight<=a.scrollTop+1;c||(a.scrollTop=a.scrollHeight-a.clientHeight)}}),b.chatText="")},a.close=function(){console.log("CHATBOX WAS CLOSED!"),0===b.currentArchive.length?(console.log("DESTROYING CHAT!"),i.$remove()):("Unassigned"!=b.currentChat.opID&&a.giveXP(b.currentChat.opID,130),b.currentChat.status="CLOSED",b.currentChat.$save()),b.ticketObject={},b.ticketExists=!1},b.toggle=function(){b.toggleState===!1?b.toggleState=!0:b.toggleState===!0&&(b.toggleState=!1)},b.checkTicket=function(){console.log("TICKET EXISTS? ",b.ticketExists),b.ticketExists===!1&&b.toggleState===!1&&(b.ticketObject=d(),b.createTicket(),b.ticketExists=!0)}}]),a.controller("LoginCtrl",["$rootScope","$scope","$firebase","$firebaseSimpleLogin","$location",function(a,b,c,d,e){console.log("LoginController!"),b.login=function(){a.loginObj.$login("password",{email:b.email,password:b.password}).then(function(a){console.log("Logged in as: ",a.uid),e.path("/dashboard")},function(a){b.error=a,console.log("Error message:",b.error.message),console.log("Login failed: ",a)})},b.hideAlert=function(a){"error"==a&&(b.error=!1)}}]),a.controller("DashboardCtrl",["$rootScope","$scope","$firebase","$firebaseSimpleLogin","$location",function(a,b,c,d,e){console.log("DashboardController!");var f=new Firebase("https://dbf-bloop.firebaseio.com/tickets");b.tickets=c(f).$asArray(),a.loginObj.$getCurrentUser().then(function(a){if(null===a)e.path("/login");else{var c=new Firebase("https://dbf-bloop.firebaseio.com/users/"+a.id);c.on("value",function(a){console.log(a.val());var c=a.val();b.theUser=c})}})}]),a.controller("TicketCtrl",["$rootScope","$scope","$firebase","$routeParams","$location",function(a,b,c,d,e){var f=new Firebase("https://dbf-bloop.firebaseio.com/tickets/"+d.fbid);b.ticket=c(f).$asObject();var g=new Firebase("https://dbf-bloop.firebaseio.com/tickets/"+d.fbid+"/archive");currentArchive=c(g),b.currentArchive=currentArchive.$asArray();var h=null;a.loginObj.$getCurrentUser().then(function(d){null===d?e.path("/login"):b.ticket.$loaded().then(function(){b.ticket.$watch(function(){null===b.ticket.$value&&e.path("/dashboard")});var f=new Firebase("https://dbf-bloop.firebaseio.com/users/"+d.id);b.op=c(f).$asObject(),b.op.$loaded().then(function(){h=b.op.id,"OPEN"===b.ticket.status&&(b.ticket.opName=b.op.firstname,b.ticket.opID=b.op.id,b.ticket.status="TAKEN",b.ticket.$save(),a.giveXP(b.op.id,10),console.log("TICKET UPDATED!"))})})}),b.statuses=[{value:"OPEN",text:"OPEN"},{value:"TAKEN",text:"TAKEN"},{value:"CLOSED",text:"CLOSED"}],b.showStatus=function(){var a=(b.statuses,{value:b.ticket.status});return console.log("TICKET STATUS: "+b.ticket.status),b.user.status&&a.length?a[0].text:"Not set"},b.saveData=function(c,d){"ticket.name"===d?b.ticket.name=c:"ticket.email"===d?b.ticket.email=c:"ticket.notes"===d?b.ticket.notes=c:"ticket.status"===d&&(b.ticket.status=c),a.giveXP(h,5),b.ticket.$save()},b.post=function(a){var c=document.querySelector("#messageArchive"),d=c.scrollHeight-c.clientHeight<=c.scrollTop+1;d||(c.scrollTop=c.scrollHeight-c.clientHeight),""!=b.repChatText&&b.currentArchive.$add({name:a,text:b.repChatText,"class":"repMessage"}),b.repChatText=""}}]),a.controller("AccountCtrl",["$rootScope","$scope","$firebase","$location",function(a,b,c,d){function e(d){var e=new Firebase(a.url+"users/"+d);b.currentUser=c(e).$asObject()}console.log("AccountController!");var f=null;b.percent=0,a.loginObj.$getCurrentUser().then(function(a){if(null===a)d.path("/login");else{e(a.id),f=a;var g=new Firebase("https://dbf-bloop.firebaseio.com/users/"+a.id);b.theUser=c(g).$asObject(),b.theUser.$loaded().then(function(){b.percent=100*b.theUser.experience/1e3})}}),b.resetPassword=function(){a.loginObj.$changePassword(f.email,b.currentPass,b.newPass).then(function(){console.log("Success!"),b.error=!1,b.success=!0},function(a){console.log("ERROR:",a),b.success=!1,b.error=a})},b.hideAlert=function(a){"error"==a&&(b.error=!1),"success"==a&&(b.success=!1)}}]),a.controller("AdminCtrl",["$rootScope","$scope","$firebase","$location",function(a,b,c,d){console.log("AdminController!");var e="https://dbf-bloop.firebaseio.com/users/";a.loginObj.$getCurrentUser().then(function(a){if(null===a)d.path("/login");else{var b=new Firebase(e+a.id);b.on("value",function(a){var b=a.val();"Admin"!=b.type&&d.path("/dashboard")})}}),b.createUser=function(){console.log(b.input.usertype);var d=b.input.usertype,f=b.input.firstname,g=b.input.lastname;a.loginObj.$createUser(b.input.email,"bloop").then(function(a){var h=new Firebase(e+a.id),i=c(h);b.user=i.$asObject(),i.$set({id:a.id,type:d,firstname:f,lastname:g,email:a.email,level:1,experience:0,ratings:[],tickets:[]}),b.success=!0,b.error=!1},function(a){b.success=!1,b.error=a,console.log("Create user failed: ",a)}),b.hideAlert=function(a){"error"==a&&(b.error=!1),"success"==a&&(b.success=!1)},b.input.firstname="",b.input.lastname="",b.input.username="",b.input.email="",b.input.usertype=""}}])}();